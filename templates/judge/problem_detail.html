{% extends 'base.html' %}
{% load markdownify %}
<p style="color: red;">[DEBUG: TEMPLATE LOADED]</p>

{% block content %}
<style>
  .problem-description p {
    margin-bottom: 1rem;
  }

  #code-editor {
    height: 380px;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid #d1d5db;
  }

  .dark #code-editor {
    border-color: #4b5563;
  }

  .problem-section h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .problem-section pre {
    background-color: #f3f4f6;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    font-family: monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .dark .problem-section pre {
    background-color: #1f2937;
  }
</style>

<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 dark:from-gray-900 dark:via-gray-900 dark:to-gray-900 px-6 py-10 rounded-xl shadow-inner animate-fadeIn">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-7xl mx-auto bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-6">

    <!-- Left: Problem Details -->
    <div>
      <a href="{% url 'dashboard' %}" class="text-indigo-600 dark:text-indigo-400 hover:underline text-sm mb-4 inline-block font-semibold">
        ⬅️ Back to Problems
      </a>

      <h2 class="text-3xl font-extrabold text-indigo-700 dark:text-indigo-400 mb-4">{{ problem.title }}</h2>

      <div class="text-gray-800 dark:text-gray-300 leading-relaxed problem-section">
        <div>
          {{ problem.description_html|safe }}
        </div>

        {% if problem.input_format_html %}
          <h3>🧾 Input </h3>
          <div>{{ problem.input_format_html|safe }}</div>
        {% endif %}

        {% if problem.output_format_html %}
          <h3>📤 Output </h3>
          <div>{{ problem.output_format_html|safe }}</div>
        {% endif %}

        {% if problem.constraints_html %}
          <h3>📌 Constraints</h3>
          <div>{{ problem.constraints_html|safe }}</div>
        {% endif %}

        {% if problem.sample_input_html %}
          <h3>🧪 Sample Input</h3>
          <pre>{{ problem.sample_input_html|safe }}</pre>
        {% endif %}

        {% if problem.sample_output_html %}
          <h3>📈 Sample Output</h3>
          <pre>{{ problem.sample_output_html|safe }}</pre>
        {% endif %}

        {% if problem.explanation_html %}
          <h3>📚 Explanation</h3>
          <div>{{ problem.explanation_html|safe }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Right: Code Editor -->
    <div class="bg-gray-50 dark:bg-gray-700 shadow-inner rounded-xl p-6 border border-gray-200 dark:border-gray-600">
      <div class="mb-4">
        <label for="language" class="block font-semibold mb-1 dark:text-gray-100">🛠 Language:</label>
        <select id="language" class="w-full border border-gray-300 dark:border-gray-600 px-3 py-2 rounded-lg bg-white dark:bg-gray-800 dark:text-white">
          <option value="python">Python</option>
          <option value="cpp">C++</option>
        </select>
      </div>

      <div class="mb-4">
        <label for="customInput" class="block font-semibold mb-1 dark:text-gray-100">📎 Custom Input (Optional):</label>
        <textarea id="customInput" rows="2" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 font-mono text-sm bg-white dark:bg-gray-800 dark:text-white" placeholder="e.g. 2 3"></textarea>
      </div>

      <!-- Monaco Editor -->
      <div id="code-editor" class="mb-4 bg-white dark:bg-gray-800"></div>

      <div class="flex gap-4 mb-4">
        <button onclick="runCode()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow">
          ▶️ Run Code
        </button>
        <button onclick="submitCode()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow">
          📤 Submit
        </button>
      </div>

      <div id="output" class="mt-2 p-4 bg-white dark:bg-gray-900 dark:text-gray-200 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-mono whitespace-pre-line"></div>
    </div>
  </div>
</div>

<!-- Monaco Editor Scripts -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script>
<script>
  const problemId = parseInt("{{ problem.id }}");
  let editor;

  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs' } });
  require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(document.getElementById('code-editor'), {
      value: '',
      language: 'python',
      theme: document.documentElement.classList.contains('dark') ? 'vs-dark' : 'vs',
      automaticLayout: true,
      fontSize: 14,
      minimap: { enabled: false }
    });

    document.getElementById('language').addEventListener('change', function () {
      const newLang = this.value === 'cpp' ? 'cpp' : 'python';
      monaco.editor.setModelLanguage(editor.getModel(), newLang);
    });
  });

  async function runCode() {
    const code = editor.getValue();
    const language = document.getElementById("language").value;
    const input = document.getElementById("customInput").value;

    const response = await fetch("/api/compile/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({ code, language, input })
    });

    const data = await response.json();
    document.getElementById("output").textContent =
      (data.output || '') + (data.error ? '\nError:\n' + data.error : '');
  }

  async function submitCode() {
    const code = editor.getValue();
    const language = document.getElementById("language").value;

    const response = await fetch("/api/submit/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({ code, language, problem_id: problemId })
    });

    const data = await response.json();
    document.getElementById("output").textContent =
      `Verdict: ${data.final_verdict}\n\n` + data.verdicts.join("\n");
  }

  function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      if (cookie.trim().startsWith('csrftoken=')) {
        return cookie.trim().substring('csrftoken='.length);
      }
    }
    return '';
  }

  // Watch for Tailwind dark mode changes and update Monaco
  const observer = new MutationObserver(() => {
    if (!editor) return;
    const isDark = document.documentElement.classList.contains('dark');
    monaco.editor.setTheme(isDark ? 'vs-dark' : 'vs');
  });

  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
</script>
{% endblock %}
